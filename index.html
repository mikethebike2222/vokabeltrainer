<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<title>Vokabeltrainer ‚Äì Leitner (Box-weise, Nachschub, Mehrsprachig)</title>

<!-- Zoom erlaubt; tempor√§rer Reset wird per JS gemacht -->
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=10, user-scalable=yes">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#1b3d8f">
<link rel="manifest" href="manifest.webmanifest?v=7">
<link rel="apple-touch-icon" sizes="180x180" href="icon-192.png">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
<style>
  :root{
    --card-max-w: 94vw; --card-max-h: 62svh;
    --card-font: clamp(22px, 6vw, 36px);
    --tile-font: clamp(18px, 4.8vw, 30px);
    --radius: 16px;
  }
  @supports not (height: 1svh){ :root{ --card-max-h: 62vh; } }
  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{ margin:0; background:#f5f7fb; display:flex; flex-direction:column; align-items:center; padding:16px; -webkit-tap-highlight-color:transparent; }
  body.learn-mode{ font-family:Georgia, "Times New Roman", serif; background:#f7f4ee; }
  body.test-mode{ font-family:Arial, Helvetica, sans-serif; background:#f5f7fb; }

  header{ width:min(100%,1100px); display:grid; grid-template-columns:1fr auto auto auto; gap:8px; align-items:center; margin-bottom:8px; }
  h1{ margin:0; font-size:20px; }
  .badge{ padding:6px 10px; border-radius:999px; font-size:13px; }
  #modeIndicator{ background:#e7eefc; color:#1b3d8f; } body.learn-mode #modeIndicator{ background:#efe6d5; color:#6f4d1d; }
  #boxBadge{ background:#ffe9ee; color:#8f1b2b; }
  #directionBadge{ background:#f1e8ff; color:#5a2ea6; }

  .gbar{ width:min(100%,1100px); display:flex; gap:10px; align-items:center; margin:6px 0 10px; flex-wrap:wrap; }
  .chip{ background:#111827; color:#fff; border-radius:999px; padding:6px 10px; font-size:12px; display:flex; align-items:center; gap:6px; }
  .chip span{ font-weight:700; }

  .progress{ width:min(100%,1100px); background:#eef2f7; border-radius:999px; height:10px; overflow:hidden; margin:4px 0 10px; }
  .progress>div{ height:100%; width:0%; background:linear-gradient(90deg,#61c454,#1aa34a); transition:width .25s; }
  .progress-label{ width:min(100%,1100px); display:flex; justify-content:space-between; font-size:12px; opacity:.8; }

  .stage{ width:min(100%,1100px); display:grid; grid-template-columns:1fr; gap:14px; }

  .pair{ width:min(var(--card-max-w),720px); display:grid; grid-template-columns:1fr 1fr; gap:12px; margin:0 auto; }
  .tile{ border-radius:var(--radius); box-shadow:0 8px 20px rgba(0,0,0,.08); padding:18px; min-height:calc(var(--card-max-h)/2.4); display:flex; align-items:center; justify-content:center; text-align:center; font-size:var(--tile-font); word-break:keep-all; overflow-wrap:anywhere; user-select:none; }
  .tile.es{ background:#fff7e9; } .tile.de{ background:#eaf4ff; }

  .controls{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin:6px 0 8px; position:sticky; bottom:calc(10px + env(safe-area-inset-bottom,0px)); padding-bottom:calc(6px + env(safe-area-inset-bottom,0px)); }
  button{ padding:14px 18px; font-size:16px; border:0; border-radius:12px; cursor:pointer; min-height:44px; min-width:44px; background:#1b3d8f; color:#fff; }
  .secondary{ background:#6b7280; } .success{ background:#176427; } .danger{ background:#8f1b2b; } .ghost{ background:#e5e7eb; color:#111827; } .pill{ border-radius:999px; }

  #testActions{ display:none; gap:10px; justify-content:center; }
  #testActions button{ min-width:120px; }

  .drawer{ position:fixed; top:0; right:-380px; width:360px; height:100vh; background:#fff; box-shadow:-16px 0 32px rgba(0,0,0,.08); z-index:25; transition:right .25s; padding:14px; overflow:auto; }
  .drawer.open{ right:0; }
  .panel{ background:#fff; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,.08); padding:12px; margin-bottom:12px; }
  .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  input[type="text"], select, textarea{ padding:11px 12px; border-radius:10px; border:1px solid #e5e7eb; background:#fff; min-height:42px; width:100%; font-size:16px; }
  textarea{ min-height:90px; resize:vertical; }

  .table-wrap{ max-height:420px; overflow:auto; border:1px solid #e5e7eb; border-radius:10px; }
  table{ width:100%; border-collapse:collapse; font-size:14px; } th,td{ border-bottom:1px solid #eef2f7; padding:8px; text-align:left; }
  thead th{ position:sticky; top:0; background:#f9fbff; z-index:1; }

  .toast{ position:fixed; left:50%; bottom:calc(20px + env(safe-area-inset-bottom,0px)); transform:translateX(-50%); background:#111827; color:#fff; padding:10px 14px; border-radius:999px; font-size:14px; opacity:0; pointer-events:none; transition:opacity .2s, transform .2s; z-index:60; }
  .toast.show{ opacity:0.98; transform:translateX(-50%) translateY(-4px); }

  /* Reduced Motion */
  @media (prefers-reduced-motion: reduce){
    .progress>div, .toast{ transition:none; }
  }

  /* Querformat: Vollbild + Safe-Area */
  @media (orientation:landscape){
    header, .progress, .progress-label, .drawer-toggle, .controls.global, .drawer, .gbar { display:none !important; }
    body { padding: 0; }
    .pair{
      width: calc(100vw - 4vw - env(safe-area-inset-left) - env(safe-area-inset-right));
      height: calc(100vh - 4vw - env(safe-area-inset-top) - env(safe-area-inset-bottom));
      max-width:none; max-height:none; margin: 2vw;
    }
    .tile{ font-size: clamp(24px, 5.5vw, 44px); }
    #landscapeBadge{ display:flex; position:fixed; left: calc(12px + env(safe-area-inset-left)); bottom: calc(12px + env(safe-area-inset-bottom)); }
    #landInfo{ display:flex; position:fixed; right: calc(12px + env(safe-area-inset-right)); top: calc(12px + env(safe-area-inset-top)); background:#111827; color:#fff; border-radius:12px; padding:10px 12px; gap:10px; align-items:center; box-shadow:0 8px 20px rgba(0,0,0,.18); z-index:50; }
    #freshBtn{ display:none; } /* default; in JS sichtbar machen wenn Box1 */
  }
  @media (max-width:520px){
    header{ grid-template-columns: 1fr auto auto; gap:6px; }
    .progress-label{ display:none; }
    .drawer{ width:92vw; right:-92vw; }
    .drawer.open{ right:0; }
  }

  #landscapeBadge{
    display:none; width:42px; height:42px; border-radius:50%; background:#111827; color:#fff;
    align-items:center; justify-content:center; font-size:13px; opacity:.85; z-index:40;
  }

  /* Diagramm (Portrait, unten) */
  #boxChartWrap{
    display:block; width:min(100%,1100px); margin:4px auto 8px; padding:6px 8px;
  }
  #boxChart{
    display:flex; gap:6px; align-items:flex-end; height:74px; padding:6px; border-radius:10px; background:#f1f5f9; box-shadow:inset 0 1px 0 rgba(0,0,0,.04);
  }
  .bar{
    flex:1; background:#c7d2fe; position:relative; border-radius:6px 6px 0 0; cursor:pointer; display:flex; align-items:flex-end; justify-content:center;
  }
  .bar span{ position:absolute; top:-18px; font-size:11px; opacity:.8; }
  .bar label{ font-size:12px; padding-bottom:4px; }
  .bar.active{ outline:2px solid #1b3d8f; outline-offset:2px; }

  /* Edit-Panel */
  #editPanel{ display:none; padding:10px; gap:8px; justify-content:center; flex-direction:column; }
</style>
</head>
<body class="learn-mode">

<header>
  <h1 data-i18n="title">Vokabeltrainer</h1>
  <div id="modeIndicator" class="badge" data-i18n="mode.learn">Lernen</div>
  <div id="directionBadge" class="badge">ES ‚Üí DE</div>
  <div id="boxBadge" class="badge">Box: ‚Äì</div>
</header>

<!-- Gamification Topbar -->
<div class="gbar">
  <div class="chip">‚≠ê <span data-i18n="points">Punkte</span>: <span id="pointsChip">0</span></div>
  <div class="chip">üéöÔ∏è <span data-i18n="level">Level</span>: <span id="levelChip">1</span></div>
  <div class="chip">üî• <span data-i18n="streak">Streak</span>: <span id="streakChip">0</span>d</div>
  <div class="chip" id="comboChip" style="display:none;">‚ö° Combo: <span id="comboVal">0</span></div>
</div>

<div class="progress"><div id="progressBar"></div></div>
<div class="progress-label">
  <div id="progressText">Fortschritt: 0 / 0 (0%)</div>
  <div id="completionText"></div>
</div>

<!-- Globale Controls (nur Portrait sichtbar) -->
<div class="controls global">
  <button id="toggleModeBtn" class="secondary pill" aria-label="Modus wechseln" data-i18n="btn.toggleMode">Lernen</button>
  <button id="editBtn" class="pill" aria-label="Karte bearbeiten" data-i18n="btn.edit">‚úèÔ∏è Bearbeiten</button>
  <button id="drawerToggle" class="ghost pill" aria-label="Werkzeugschublade √∂ffnen" data-i18n="btn.tools">‚ò∞ Werkzeug</button>
</div>

<!-- Box-weise Info (nur Querformat per CSS) -->
<div id="landInfo" style="display:none;">
  <div id="landInfoText">B‚Äì: 0</div>
</div>

<div class="stage">
  <main>
    <!-- LERNMODUS -->
    <div id="learnPair" class="pair" role="group" aria-label="Lernmodus Karte">
      <div id="tileEs" class="tile es" role="region" aria-label="Spanisch" aria-live="polite">‚Äî</div>
      <div id="tileDe" class="tile de" role="region" aria-label="Deutsch" aria-live="polite">‚Äî</div>
    </div>

    <!-- PR√úFMODUS (Box-weise) -->
    <div id="testPair" class="pair" style="display:none;" role="button" tabindex="0" aria-label="Aufgabe anzeigen oder Antwort aufdecken">
      <div id="testLeft" class="tile es" role="region" aria-live="polite">‚Äî</div>
      <div id="testRight" class="tile de" role="region" aria-live="polite">‚Äî</div>
    </div>
    <div id="testActions" class="controls" aria-label="Antwort bewerten">
      <button id="btnWrong" class="danger" aria-label="Antwort war falsch" data-i18n="btn.wrong">‚ùå Falsch</button>
      <button id="btnRight" class="success" aria-label="Antwort war richtig" data-i18n="btn.right">‚úÖ Richtig</button>
    </div>

    <!-- Inline-Editor -->
    <div id="editPanel" class="controls" aria-label="Karte bearbeiten">
      <textarea id="editEs" placeholder="Spanisch ‚Äì hier bearbeiten ‚Ä¶" data-i18n-placeholder="ph.es"></textarea>
      <textarea id="editDe" placeholder="Deutsch ‚Äì hier bearbeiten ‚Ä¶" data-i18n-placeholder="ph.de"></textarea>
      <div class="row" style="justify-content:center;">
        <button id="saveEditBtn" class="success" data-i18n="btn.save">Speichern</button>
        <button id="cancelEditBtn" class="secondary" data-i18n="btn.cancel">Abbrechen</button>
      </div>
    </div>

    <!-- Meta -->
    <div id="metaInfo" style="text-align:center; opacity:.75; font-size:13px;">
      <span data-i18n="meta.box">Box</span>: <span id="metaBox">‚Äì</span> ‚Ä¢ <span data-i18n="meta.wrong">Falsch gez√§hlt</span>: <span id="metaWrong">0</span>
    </div>

    <!-- Box-Diagramm (Portrait, klickbar zur Boxwahl) -->
    <div id="boxChartWrap">
      <div id="boxChart" aria-label="Boxauswahl Diagramm"></div>
      <div style="text-align:center; font-size:12px; opacity:.7;" id="chartHint" data-i18n="chart.hint">Tipp: Tippe auf eine Box, um sie zu pr√ºfen.</div>
    </div>
  </main>
</div>

<!-- Querformat-Badge -->
<div id="landscapeBadge">B1</div>

<!-- Schublade / Werkzeug -->
<aside class="drawer" id="drawer">
  <div class="row" style="justify-content:space-between;">
    <h3 data-i18n="tools.title">Werkzeuge</h3>
    <button id="drawerClose" class="ghost pill" data-i18n="btn.close">Schlie√üen</button>
  </div>

  <div class="panel">
    <h3 data-i18n="tools.decks">Decks</h3>
    <div class="row">
      <select id="deckSelect"></select>
      <button id="deckAddBtn" class="pill">‚ûï</button>
      <button id="deckRenameBtn" class="pill secondary">‚úèÔ∏è</button>
      <button id="deckDeleteBtn" class="pill danger">üóëÔ∏è</button>
    </div>
  </div>

  <div class="panel">
    <h3 data-i18n="tools.direction">Richtung</h3>
    <div class="row">
      <button id="toggleDirectionBtn" class="pill">ES ‚Üí DE</button>
    </div>
  </div>

  <div class="panel">
    <h3 data-i18n="tools.free">Freies √úben</h3>
    <div class="row">
      <label style="display:flex;align-items:center;gap:8px;">
        <input type="checkbox" id="freePracticeChk"> <span data-i18n="tools.free.desc">F√§lligkeit ignorieren (Box 2‚Äì5 + gelernte Box-1)</span>
      </label>
    </div>
  </div>

  <div class="panel">
    <h3 data-i18n="tools.lang">Sprache / Language</h3>
    <div class="row">
      <select id="langSelect">
        <option value="de">Deutsch</option>
        <option value="en">English</option>
        <option value="sv">Svenska</option>
        <option value="es">Espa√±ol</option>
      </select>
    </div>
  </div>

  <div class="panel">
    <h3 data-i18n="tools.csv">CSV Import (ES,DE)</h3>
    <input type="file" id="csvFile" accept=".csv">
    <div style="font-size:12px;opacity:.7" data-i18n="tools.csv.help">UTF-8 / Win-1252 / ISO-8859-1; Komma/Semikolon</div>
  </div>

  <div class="panel">
    <h3 data-i18n="tools.add">Neue Karte</h3>
    <div class="row">
      <input type="text" id="spanish" placeholder="Spanisch" data-i18n-placeholder="ph.es">
      <input type="text" id="german" placeholder="Deutsch" data-i18n-placeholder="ph.de">
      <button id="addCardBtn" data-i18n="btn.add">Hinzuf√ºgen</button>
    </div>
  </div>

  <div class="panel">
    <h3 data-i18n="tools.stats">Statistik</h3>
    <table id="statsTable">
      <tr><th data-i18n="tab.box">Box</th><th data-i18n="tab.cards">Karten</th><th data-i18n="tab.due">F√§llig</th><th data-i18n="tab.next">N√§chstes</th></tr>
    </table>
    <div id="heatWrap" style="margin-top:8px;font-size:12px;opacity:.8;"></div>
  </div>

  <div class="panel">
    <h3 data-i18n="tools.all">Alle Karten</h3>
    <div class="row" style="margin-bottom:8px;">
      <input type="text" id="searchInput" placeholder="Suchen ‚Ä¶ (ES/DE)" data-i18n-placeholder="ph.search">
      <select id="listSortSelect">
        <option value="boxdesc" data-i18n="sort.boxdesc">Box ‚Üì</option>
        <option value="wrongdesc" data-i18n="sort.wrongdesc">Schwierigkeit ‚Üì</option>
        <option value="alphaes" data-i18n="sort.alphaes">Spanisch A‚ÄìZ</option>
        <option value="alphade" data-i18n="sort.alphade">Deutsch A‚ÄìZ</option>
      </select>
      <label style="font-size:12px;"><input type="checkbox" id="showReserveChk"> <span data-i18n="tools.reserve">Reserve</span></label>
    </div>
    <div class="table-wrap">
      <table>
        <thead><tr><th data-i18n="th.es">Spanisch</th><th data-i18n="th.de">Deutsch</th><th data-i18n="th.box">Box</th><th data-i18n="th.wrong">Falsch</th><th data-i18n="th.last">Zuletzt</th><th data-i18n="th.action">Aktion</th></tr></thead>
        <tbody id="cardsTable"></tbody>
      </table>
    </div>
  </div>

  <div class="panel">
    <h3 data-i18n="tools.manage">Verwalten</h3>
    <div class="row">
      <button id="deleteBtn" class="danger" data-i18n="btn.delete">Aktive Karte l√∂schen</button>
      <button id="resetProgressBtn" class="secondary" data-i18n="btn.resetProgress">Nur Fortschritt</button>
      <button id="resetAllBtn" class="danger" data-i18n="btn.resetAll">Alles l√∂schen</button>
    </div>
  </div>

  <div class="panel" style="font-size:12px; opacity:.85">
    <div data-i18n="tools.note">Neue Karten kommen √ºber den Button ‚ÄûFrische Karten‚Äú in 7er-Bl√∂cken hinzu. Pr√ºfmodus l√§uft Box-weise bis leer.</div>
  </div>
</aside>

<div id="toast" class="toast"></div>

<!-- Frische-Karten-Button (nur Querformat sichtbar gemacht, wenn Box1) -->
<button id="freshBtn" class="pill" style="position:fixed; right:12px; top:68px; z-index:50; display:none;">üÜï 7 <span data-i18n="btn.fresh">Frische Karten</span></button>

<script>
/* ===== i18n (DE/EN/SV/ES) ===== */
const I18N = {
  de: {
    title:"Vokabeltrainer",
    "mode.learn":"Lernen","mode.test":"Pr√ºfen",
    points:"Punkte", level:"Level", streak:"Streak",
    "btn.toggleMode":"Lernen","btn.edit":"‚úèÔ∏è Bearbeiten","btn.tools":"‚ò∞ Werkzeug","btn.close":"Schlie√üen",
    "btn.wrong":"‚ùå Falsch","btn.right":"‚úÖ Richtig","btn.save":"Speichern","btn.cancel":"Abbrechen",
    "btn.add":"Hinzuf√ºgen","btn.delete":"Aktive Karte l√∂schen","btn.resetProgress":"Nur Fortschritt","btn.resetAll":"Alles l√∂schen",
    "btn.fresh":"Frische Karten",
    "tools.title":"Werkzeuge","tools.decks":"Decks","tools.direction":"Richtung","tools.free":"Freies √úben",
    "tools.free.desc":"F√§lligkeit ignorieren (Box 2‚Äì5 + gelernte Box-1)",
    "tools.lang":"Sprache / Language","tools.csv":"CSV Import (ES,DE)","tools.csv.help":"UTF-8 / Win-1252 / ISO-8859-1; Komma/Semikolon",
    "tools.add":"Neue Karte","tools.stats":"Statistik","tools.all":"Alle Karten","tools.reserve":"Reserve",
    "tools.manage":"Verwalten","tools.note":"Neue Karten kommen √ºber den Button ‚ÄûFrische Karten‚Äú in 7er-Bl√∂cken hinzu. Pr√ºfmodus l√§uft Box-weise bis leer.",
    "tab.box":"Box","tab.cards":"Karten","tab.due":"F√§llig","tab.next":"N√§chstes",
    "th.es":"Spanisch","th.de":"Deutsch","th.box":"Box","th.wrong":"Falsch","th.last":"Zuletzt","th.action":"Aktion",
    "ph.es":"Spanisch","ph.de":"Deutsch","ph.search":"Suchen ‚Ä¶ (ES/DE)",
    "chart.hint":"Tipp: Tippe auf eine Box, um sie zu pr√ºfen.",
    "toast.saved":"Gespeichert ‚úÖ","toast.deleted":"Gel√∂scht üóëÔ∏è","toast.added":"Zur Reserve hinzugef√ºgt","toast.reset":"Fortschritt zur√ºckgesetzt","toast.init":"Neu initialisiert"
  },
  en: {
    title:"Flashcard Trainer",
    "mode.learn":"Learn","mode.test":"Test",
    points:"Points", level:"Level", streak:"Streak",
    "btn.toggleMode":"Learn","btn.edit":"‚úèÔ∏è Edit","btn.tools":"‚ò∞ Tools","btn.close":"Close",
    "btn.wrong":"‚ùå Wrong","btn.right":"‚úÖ Right","btn.save":"Save","btn.cancel":"Cancel",
    "btn.add":"Add","btn.delete":"Delete active card","btn.resetProgress":"Reset progress","btn.resetAll":"Reset all",
    "btn.fresh":"Fresh cards",
    "tools.title":"Tools","tools.decks":"Decks","tools.direction":"Direction","tools.free":"Free practice",
    "tools.free.desc":"Ignore due (Boxes 2‚Äì5 + learned Box-1)",
    "tools.lang":"Language","tools.csv":"CSV Import (ES,DE)","tools.csv.help":"UTF-8 / Win-1252 / ISO-8859-1; comma/semicolon",
    "tools.add":"New Card","tools.stats":"Statistics","tools.all":"All Cards","tools.reserve":"Reserve",
    "tools.manage":"Manage","tools.note":"Add new cards in batches of 7 via ‚ÄúFresh cards‚Äù. Test mode runs box-by-box until empty.",
    "tab.box":"Box","tab.cards":"Cards","tab.due":"Due","tab.next":"Next",
    "th.es":"Spanish","th.de":"German","th.box":"Box","th.wrong":"Wrong","th.last":"Last","th.action":"Action",
    "ph.es":"Spanish","ph.de":"German","ph.search":"Search ‚Ä¶ (ES/DE)",
    "chart.hint":"Tip: Tap a box to drill it.",
    "toast.saved":"Saved ‚úÖ","toast.deleted":"Deleted üóëÔ∏è","toast.added":"Added to reserve","toast.reset":"Progress reset","toast.init":"Reinitialized"
  },
  sv: {
    title:"Glosstr√§nare",
    "mode.learn":"L√§ra","mode.test":"Testa",
    points:"Po√§ng", level:"Niv√•", streak:"Streak",
    "btn.toggleMode":"L√§ra","btn.edit":"‚úèÔ∏è Redigera","btn.tools":"‚ò∞ Verktyg","btn.close":"St√§ng",
    "btn.wrong":"‚ùå Fel","btn.right":"‚úÖ R√§tt","btn.save":"Spara","btn.cancel":"Avbryt",
    "btn.add":"L√§gg till","btn.delete":"Ta bort aktivt kort","btn.resetProgress":"√Öterst√§ll framsteg","btn.resetAll":"√Öterst√§ll allt",
    "btn.fresh":"Nya kort",
    "tools.title":"Verktyg","tools.decks":"Leks","tools.direction":"Riktning","tools.free":"Fritt l√§ge",
    "tools.free.desc":"Ignorera f√∂rfall (L√•dor 2‚Äì5 + inl√§rd L√•da-1)",
    "tools.lang":"Spr√•k","tools.csv":"CSV-import (ES,DE)","tools.csv.help":"UTF-8 / Win-1252 / ISO-8859-1; komma/semikolon",
    "tools.add":"Nytt kort","tools.stats":"Statistik","tools.all":"Alla kort","tools.reserve":"Reserv",
    "tools.manage":"Hantera","tools.note":"L√§gg till 7 nya kort via ‚ÄùNya kort‚Äù. Testl√§get k√∂r l√•dvis tills tomt.",
    "tab.box":"L√•da","tab.cards":"Kort","tab.due":"F√∂rfallna","tab.next":"N√§sta",
    "th.es":"Spanska","th.de":"Tyska","th.box":"L√•da","th.wrong":"Fel","th.last":"Senast","th.action":"√Ötg√§rd",
    "ph.es":"Spanska","ph.de":"Tyska","ph.search":"S√∂k ‚Ä¶ (ES/DE)",
    "chart.hint":"Tips: Tryck p√• en l√•da f√∂r att √∂va den.",
    "toast.saved":"Sparat ‚úÖ","toast.deleted":"Borttagen üóëÔ∏è","toast.added":"Tillagd i reserv","toast.reset":"Framsteg √•terst√§llda","toast.init":"Initierad p√• nytt"
  },
  es: {
    title:"Entrenador de Vocabulario",
    "mode.learn":"Aprender","mode.test":"Probar",
    points:"Puntos", level:"Nivel", streak:"Racha",
    "btn.toggleMode":"Aprender","btn.edit":"‚úèÔ∏è Editar","btn.tools":"‚ò∞ Herramientas","btn.close":"Cerrar",
    "btn.wrong":"‚ùå Incorrecto","btn.right":"‚úÖ Correcto","btn.save":"Guardar","btn.cancel":"Cancelar",
    "btn.add":"A√±adir","btn.delete":"Borrar tarjeta activa","btn.resetProgress":"Solo progreso","btn.resetAll":"Borrar todo",
    "btn.fresh":"Tarjetas nuevas",
    "tools.title":"Herramientas","tools.decks":"Mazos","tools.direction":"Direcci√≥n","tools.free":"Pr√°ctica libre",
    "tools.free.desc":"Ignorar vencimiento (Cajas 2‚Äì5 + Caja-1 aprendida)",
    "tools.lang":"Idioma","tools.csv":"Importar CSV (ES,DE)","tools.csv.help":"UTF-8 / Win-1252 / ISO-8859-1; coma/punto y coma",
    "tools.add":"Nueva tarjeta","tools.stats":"Estad√≠sticas","tools.all":"Todas las tarjetas","tools.reserve":"Reserva",
    "tools.manage":"Administrar","tools.note":"A√±ade 7 tarjetas nuevas con ‚ÄúTarjetas nuevas‚Äù. El modo prueba funciona por caja hasta vaciar.",
    "tab.box":"Caja","tab.cards":"Tarjetas","tab.due":"Vencen","tab.next":"Pr√≥x.",
    "th.es":"Espa√±ol","th.de":"Alem√°n","th.box":"Caja","th.wrong":"Fallos","th.last":"√öltima","th.action":"Acci√≥n",
    "ph.es":"Espa√±ol","ph.de":"Alem√°n","ph.search":"Buscar ‚Ä¶ (ES/DE)",
    "chart.hint":"Consejo: toca una caja para repasarla.",
    "toast.saved":"Guardado ‚úÖ","toast.deleted":"Eliminado üóëÔ∏è","toast.added":"A√±adido a reserva","toast.reset":"Progreso reiniciado","toast.init":"Reiniciado"
  }
};
let lang = localStorage.getItem("leitner_lang") || "de";
function t(k){ return (I18N[lang] && I18N[lang][k]) || (I18N["de"][k]||k); }
function applyI18n(){
  document.documentElement.lang = lang;
  document.querySelectorAll("[data-i18n]").forEach(el=>{ el.textContent = t(el.getAttribute("data-i18n")); });
  document.querySelectorAll("[data-i18n-placeholder]").forEach(el=>{ el.setAttribute("placeholder", t(el.getAttribute("data-i18n-placeholder"))); });
  // Moduslabel anpassen
  document.getElementById("modeIndicator").textContent = (mode==="pr√ºfen") ? t("mode.test") : t("mode.learn");
  document.getElementById("toggleModeBtn").textContent = (mode==="pr√ºfen") ? t("mode.test") : t("mode.learn");
}

/* ===== Helpers & Setup ===== */
function setVH(){ const vh=window.innerHeight*0.01; document.documentElement.style.setProperty('--vh', vh+'px'); }
addEventListener('resize', setVH); setVH();

const LS_DECKS="leitnerDecks";
function uuid(){ return Math.random().toString(36).slice(2,10); }
function cryptoId(){ return Math.random().toString(36).slice(2)+Math.random().toString(36).slice(2); }
const todayKey = () => new Date().toLocaleDateString('sv-SE');

/* ===== Deck/Zustand laden ===== */
let decks=JSON.parse(localStorage.getItem(LS_DECKS)||"[]");
if(decks.length===0){ const id=uuid(); decks=[{id,name:"Default"}]; localStorage.setItem(LS_DECKS,JSON.stringify(decks)); }
let currentDeckId=localStorage.getItem("leitnerCurrentDeck")||decks[0].id;
function deckKey(k){ return `${k}_${currentDeckId}`; }

/* ===== Leitner-Config (keine harten Limits) ===== */
const boxIntervals=[1,2,4,9,14]; // Tage ‚Äì beliebig anpassbar
const batchSizeFresh=7;           // ‚ÄûFrische Karten‚Äú-Stapelgr√∂√üe
const noRepeatBuffer=4;           // Karte erst nach X anderen wieder zeigen

/* ===== Daten ===== */
let activeCards=JSON.parse(localStorage.getItem(deckKey("leitnerActive")))||[];
let reserveCards=JSON.parse(localStorage.getItem(deckKey("leitnerReserve")))||[];
let learnedCards=JSON.parse(localStorage.getItem(deckKey("leitnerLearned")))||[];
let mode="lernen";
let direction=localStorage.getItem(deckKey("leitnerDirection"))||"es2de";
let freePractice = JSON.parse(localStorage.getItem(deckKey("freePractice") )||"false");
let currentTestBox = parseInt(localStorage.getItem(deckKey("currentTestBox"))||"1",10);

/* Gamification */
let points = parseInt(localStorage.getItem(deckKey("points"))||"0",10);
let level  = parseInt(localStorage.getItem(deckKey("level"))||"1",10);
let streak = parseInt(localStorage.getItem(deckKey("streak"))||"0",10);
let lastActivityDate = localStorage.getItem(deckKey("lastActivityDate"))||null;
let achievements = JSON.parse(localStorage.getItem(deckKey("achievements"))||"[]");
let dayCounts = JSON.parse(localStorage.getItem(deckKey("dayCounts"))||"{}"); // {"YYYY-MM-DD": n}
let combo=0;

/* Haptik (Vibration) */
let haptics = JSON.parse(localStorage.getItem(deckKey("haptics")) || "true");

/* ===== Viewport-Zoom-Fix (iOS/Android) ===== */
const viewportMeta = document.querySelector('meta[name="viewport"]');
const BASE_VP = 'width=device-width, initial-scale=1, viewport-fit=cover';
function lockAndResetZoom() {
  if (!viewportMeta) return;
  viewportMeta.setAttribute('content', BASE_VP + ', maximum-scale=1, user-scalable=no');
  window.scrollTo(0, 0);
  setTimeout(() => {
    viewportMeta.setAttribute('content', BASE_VP + ', maximum-scale=10, user-scalable=yes');
  }, 250);
}
function resetZoomIfNeeded(force = false) {
  try { if (force) return lockAndResetZoom(); lockAndResetZoom(); } catch(e) {}
}
addEventListener('orientationchange', () => setTimeout(() => resetZoomIfNeeded(true), 60));

/* ===== DOM ===== */
const body=document.body;
const modeIndicator=document.getElementById("modeIndicator");
const directionBadge=document.getElementById("directionBadge");
const boxBadge=document.getElementById("boxBadge");
const progressBar=document.getElementById("progressBar"), progressText=document.getElementById("progressText"), completionText=document.getElementById("completionText");
const tileEs=document.getElementById("tileEs"), tileDe=document.getElementById("tileDe");
const learnPair=document.getElementById("learnPair");
const testPair=document.getElementById("testPair"), testLeft=document.getElementById("testLeft"), testRight=document.getElementById("testRight"), testActions=document.getElementById("testActions");
const btnRight=document.getElementById("btnRight"), btnWrong=document.getElementById("btnWrong");
const toggleModeBtn=document.getElementById("toggleModeBtn");
const editBtn=document.getElementById("editBtn");
const editPanel=document.getElementById("editPanel"), editEs=document.getElementById("editEs"), editDe=document.getElementById("editDe"), saveEditBtn=document.getElementById("saveEditBtn"), cancelEditBtn=document.getElementById("cancelEditBtn");
const drawer=document.getElementById("drawer"), drawerToggle=document.getElementById("drawerToggle"), drawerClose=document.getElementById("drawerClose");
const toggleDirectionBtn=document.getElementById("toggleDirectionBtn");
const freePracticeChk=document.getElementById("freePracticeChk");
const deckSelect=document.getElementById("deckSelect"), deckAddBtn=document.getElementById("deckAddBtn"), deckRenameBtn=document.getElementById("deckRenameBtn"), deckDeleteBtn=document.getElementById("deckDeleteBtn");
const csvFileInput=document.getElementById("csvFile"), addCardBtn=document.getElementById("addCardBtn");
const statsTable=document.getElementById("statsTable");
const resetProgressBtn=document.getElementById("resetProgressBtn"), resetAllBtn=document.getElementById("resetAllBtn"), deleteBtn=document.getElementById("deleteBtn");
const cardsTable=document.getElementById("cardsTable"), searchInput=document.getElementById("searchInput"), listSortSelect=document.getElementById("listSortSelect"), showReserveChk=document.getElementById("showReserveChk");
const metaBox=document.getElementById("metaBox"), metaWrong=document.getElementById("metaWrong");
const landscapeBadge=document.getElementById("landscapeBadge");
const toastEl=document.getElementById("toast");
const pointsChip=document.getElementById("pointsChip"), levelChip=document.getElementById("levelChip"), streakChip=document.getElementById("streakChip");
const comboChip=document.getElementById("comboChip"), comboVal=document.getElementById("comboVal");
const landInfo=document.getElementById("landInfo"), landInfoText=document.getElementById("landInfoText");
const boxChart=document.getElementById("boxChart"), boxChartWrap=document.getElementById("boxChartWrap");
const langSelect=document.getElementById("langSelect");
const freshBtn=document.getElementById("freshBtn");

/* ===== Utils ===== */
function saveData(){
  localStorage.setItem(deckKey("leitnerActive"),JSON.stringify(activeCards));
  localStorage.setItem(deckKey("leitnerReserve"),JSON.stringify(reserveCards));
  localStorage.setItem(deckKey("leitnerLearned"),JSON.stringify(learnedCards));
  localStorage.setItem(deckKey("leitnerDirection"),direction);
  localStorage.setItem(deckKey("points"), points);
  localStorage.setItem(deckKey("level"), level);
  localStorage.setItem(deckKey("streak"), streak);
  localStorage.setItem(deckKey("achievements"), JSON.stringify(achievements));
  localStorage.setItem(deckKey("lastActivityDate"), lastActivityDate||"");
  localStorage.setItem(deckKey("dayCounts"), JSON.stringify(dayCounts));
  localStorage.setItem(deckKey("freePractice"), JSON.stringify(freePractice));
  localStorage.setItem(deckKey("haptics"), JSON.stringify(haptics));
  localStorage.setItem(deckKey("currentTestBox"), String(currentTestBox));
  localStorage.setItem("leitner_lang", lang);
}
function saveDecks(){ localStorage.setItem(LS_DECKS,JSON.stringify(decks)); localStorage.setItem("leitnerCurrentDeck",currentDeckId); }
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }
function daysBetween(a,b){ return Math.floor((a-b)/(1000*60*60*24)); }
function toast(msg){ toastEl.textContent=msg; toastEl.classList.add("show"); setTimeout(()=>toastEl.classList.remove("show"), 1400); }
function vibrate(ms=15){ if(!haptics) return; try{ navigator.vibrate && navigator.vibrate(ms); }catch(e){} }

function getDueCardsForBox(box){
  const today=new Date();
  return activeCards.filter(card=>{
    if(card.box!==box) return false;
    if(mode==="lernen") return true;
    if(freePractice){ // freier Modus: Box 2‚Äì5 + gelernte Box1 sind okay; wir pr√ºfen aber gezielt Box=box
      if(card.box===1 && !card.introduced) return false;
    }
    if(card.lastSeen===null) return true;
    return daysBetween(today,new Date(card.lastSeen))>=boxIntervals[card.box-1];
  });
}

/* ===== Fortschritt / Stats ===== */
function totals(){ const total=activeCards.length+reserveCards.length+learnedCards.length; const learned=learnedCards.length; return {total, learned}; }
function updateProgress(){
  const {total,learned}=totals();
  const pct= total? Math.round((learned/total)*100):100;
  progressBar.style.width=pct+"%";
  const txt = `${t("tab.cards")}: ${learned} / ${total} (${pct}%)`;
  progressText.textContent=txt;
  completionText.textContent=(activeCards.length===0&&reserveCards.length===0&&total>0)?"üéâ":""; // neutral
}
function updateStats(){
  statsTable.innerHTML=`<tr><th>${t("tab.box")}</th><th>${t("tab.cards")}</th><th>${t("tab.due")}</th><th>${t("tab.next")}</th></tr>`;
  const today=new Date();
  for(let b=1;b<=5;b++){
    const inBox=activeCards.filter(c=>c.box===b);
    const due=inBox.filter(c=>{
      if(c.lastSeen===null) return true;
      return daysBetween(today,new Date(c.lastSeen))>=boxIntervals[b-1];
    }).length;
    let next="-";
    if(inBox.length){
      const ds=inBox.map(c=>{ if(!c.lastSeen) return new Date(0); const d=new Date(c.lastSeen); d.setDate(d.getDate()+boxIntervals[b-1]); return d; });
      const soonest=new Date(Math.min(...ds.map(d=>d.getTime())));
      next=soonest.getTime()>0?soonest.toLocaleDateString('de-DE'):"heute";
    }
    statsTable.insertAdjacentHTML("beforeend",`<tr><td>${b}</td><td>${inBox.length}</td><td>${due}</td><td>${next}</td></tr>`);
  }
  buildHeat(); buildBoxChart();
}
function buildHeat(){
  const wrap=document.getElementById("heatWrap");
  const days=14, out=[];
  for(let i=days-1;i>=0;i--){
    const d=new Date(); d.setDate(d.getDate()-i);
    const key=d.toLocaleDateString('sv-SE');
    const n=dayCounts[key]||0;
    const shade = n===0 ? "#e5e7eb" : n<5 ? "#bbf7d0" : n<15 ? "#86efac" : "#22c55e";
    out.push(`<span title="${key}: ${n}" style="display:inline-block;width:12px;height:12px;background:${shade};border-radius:3px;margin:2px;"></span>`);
  }
  wrap.innerHTML = `<div style="margin-top:6px;">Aktivit√§t (14T): ${out.join("")}</div>`;
}

/* ===== Gamification ===== */
function addPointsFor(card, correct=true){
  if(!correct) { combo=0; comboChip.style.display="none"; return; }
  const inc = Math.max(1, Math.min(5, card.box));
  points += inc;
  combo += 1;
  if(combo>=2){ comboChip.style.display="flex"; comboVal.textContent=combo; }
  const newLevel = Math.max(1, Math.floor(points/100) + 1);
  if(newLevel>level){ level=newLevel; toast(`üéöÔ∏è ${t("level")} ${level}`); }
}
function markActivity(){
  const today=todayKey();
  if(lastActivityDate!==today){
    if(lastActivityDate){
      const d1=new Date(lastActivityDate), d2=new Date(today);
      const diff=Math.round((d2-d1)/(1000*60*60*24));
      if(diff===1) streak+=1;
      else streak=1;
    }else{ streak=1; }
    lastActivityDate=today;
  }
  dayCounts[today]=(dayCounts[today]||0)+1;
  saveData(); updateGamification();
}
function updateGamification(){
  pointsChip.textContent=points;
  levelChip.textContent=level;
  streakChip.textContent=streak;
}

/* ===== Render / Auswahl ===== */
let currentCard=null, testPhase="prompt";
let lastShownIds=[]; // Anti-Repeat-Buffer

function pickNextTestCardFromBox(box){
  let pool = getDueCardsForBox(box).filter(c=>!lastShownIds.includes(c.id));
  if(pool.length===0){
    // Wenn alle zuletzt gezeigt wurden, Buffer freigeben
    lastShownIds = [];
    pool = getDueCardsForBox(box);
  }
  if(pool.length===0) return null;
  shuffle(pool);
  return pool[0];
}

function render(){
  applyI18n();
  updateGamification(); updateProgress(); updateStats();
  body.classList.toggle("test-mode", mode==="pr√ºfen");
  body.classList.toggle("learn-mode", mode==="lernen");

  modeIndicator.textContent = (mode==="pr√ºfen") ? t("mode.test") : t("mode.learn");
  toggleModeBtn.textContent = (mode==="pr√ºfen") ? t("mode.test") : t("mode.learn");

  directionBadge.textContent = (direction==="es2de") ? "ES ‚Üí DE" : "DE ‚Üí ES";
  freePracticeChk.checked = !!freePractice;

  updateLandInfo();
  buildBoxChart();

  if(mode==="lernen"){
    learnPair.style.display="grid"; testPair.style.display="none"; testActions.style.display="none";
    // Lernmodus: zeige exemplarisch eine Karte aus Box 1 (wenn vorhanden)
    const b1=activeCards.filter(c=>c.box===1);
    currentCard = b1[0]||null;
    tileEs.textContent=currentCard?currentCard.es:"‚Äî";
    tileDe.textContent=currentCard?currentCard.de:"‚Äî";
    if(currentCard && !currentCard.introduced){ currentCard.introduced=true; saveData(); }
    updateMeta();
  }else{
    learnPair.style.display="none"; testPair.style.display="grid"; testPhase="prompt"; testActions.style.display="none";
    const next = pickNextTestCardFromBox(currentTestBox);
    currentCard = next;
    if(!currentCard){
      testLeft.textContent="‚Äî"; testRight.textContent=t("tools.note"); // leerer Hinweis
      updateMeta();
      // Wenn Box leer: im freien Modus (oder immer) Boxwahl erlauben
      toast(`${t("tab.box")} ${currentTestBox} ‚úì`);
      return;
    }
    const src = (direction==="es2de") ? currentCard.es : currentCard.de;
    testLeft.textContent = src; testRight.textContent="‚Äî";
    updateMeta();
  }
}

function updateMeta(){
  const b=currentCard?currentCard.box:"‚Äì";
  document.getElementById("metaBox").textContent=b;
  document.getElementById("metaWrong").textContent=currentCard?(currentCard.wrong||0):0;
  boxBadge.textContent=`${t("tab.box")}: `+b;
  landscapeBadge.textContent="B"+b;
}
function updateLandInfo(){
  const countInBox = activeCards.filter(c=>c.box===currentTestBox).length;
  landInfoText.textContent = `B${currentTestBox}: ${countInBox}`;
  landInfo.style.display = (window.matchMedia("(orientation: landscape)").matches) ? "flex" : "none";
  // Fresh-Button nur in Box1 im Querformat
  const showFresh = (currentTestBox===1) && window.matchMedia("(orientation: landscape)").matches;
  freshBtn.style.display = showFresh ? "block" : "none";
}

/* ===== Interaktionen ===== */
testPair.addEventListener("click", revealAnswer);
testPair.addEventListener("keydown", (e)=>{ if((e.key===" "||e.key==="Enter") && testPhase==="prompt"){ e.preventDefault(); revealAnswer(); } });

function revealAnswer(){
  if(mode!=="pr√ºfen" || !currentCard || testPhase!=="prompt") return;
  const tgt = (direction==="es2de") ? currentCard.de : currentCard.es;
  testRight.textContent=tgt; testPhase="answer"; testActions.style.display="flex";
}

btnRight.addEventListener("click", ()=>{
  if(mode!=="pr√ºfen"||!currentCard) return;
  vibrate(); addPointsFor(currentCard, true); markActivity();

  // Aufstieg sofort ‚Äì niemals blockieren
  if(currentCard.box===5){
    const i=activeCards.indexOf(currentCard); if(i>=0) activeCards.splice(i,1);
    learnedCards.push({...currentCard, learnedAt:new Date().toISOString()});
  }else{
    currentCard.box = currentCard.box + 1;
    currentCard.lastSeen = new Date().toISOString();
  }
  // Anti-Repeat Puffer
  pushNoRepeat(currentCard.id);
  currentCard=null; saveData(); nextInBoxOrDone();
});
btnWrong.addEventListener("click", ()=>{
  if(mode!=="pr√ºfen"||!currentCard) return;
  vibrate(); addPointsFor(currentCard,false); markActivity();
  currentCard.box = Math.max(1, currentCard.box-1);
  currentCard.wrong = (currentCard.wrong||0)+1;
  currentCard.lastSeen=new Date().toISOString();
  pushNoRepeat(currentCard.id);
  currentCard=null; saveData(); nextInBoxOrDone();
});

function pushNoRepeat(id){
  lastShownIds.unshift(id);
  if(lastShownIds.length>noRepeatBuffer) lastShownIds.pop();
}

function nextInBoxOrDone(){
  // Bleibe in der Box, bis dort keine f√§llige Karte mehr ist
  const next = pickNextTestCardFromBox(currentTestBox);
  if(next){
    currentCard = next; testPhase="prompt"; testActions.style.display="none";
    const src = (direction==="es2de") ? currentCard.es : currentCard.de;
    testLeft.textContent = src; testRight.textContent="‚Äî";
    updateMeta(); updateLandInfo();
  }else{
    // Box leer ‚Üí Hinweis und Boxwahl erm√∂glichen (Diagramm/Quer-Panel)
    testLeft.textContent="‚Äî"; testRight.textContent=t("tools.note");
    testActions.style.display="none";
    updateMeta(); updateLandInfo(); toast(`${t("tab.box")} ${currentTestBox} ‚úì`);
  }
}

/* Edit */
function autoResize(el){ el.style.height='auto'; el.style.height=(el.scrollHeight+4)+'px'; }
editEs.addEventListener('input', ()=>autoResize(editEs));
editDe.addEventListener('input', ()=>autoResize(editDe));
editBtn.addEventListener("click", ()=>{
  if(!currentCard) return;
  editPanel.style.display = (editPanel.style.display==="none"||editPanel.style.display==="") ? "flex" : "none";
  editEs.value=currentCard.es; editDe.value=currentCard.de; autoResize(editEs); autoResize(editDe);
});
cancelEditBtn.addEventListener("click", ()=>{ editPanel.style.display="none"; setTimeout(()=>resetZoomIfNeeded(true), 30); });
saveEditBtn.addEventListener("click", ()=>{
  if(!currentCard) return;
  const newEs=editEs.value.trim(), newDe=editDe.value.trim();
  if(!newEs || !newDe){ alert("Bitte beide Felder ausf√ºllen."); return; }
  const dup = activeCards.some(c=>c!==currentCard && c.es===newEs)
           || reserveCards.some(c=>c.es===newEs)
           || learnedCards.some(c=>c.es===newEs);
  if(dup){ alert("Es existiert bereits eine Karte mit derselben spanischen Seite."); return; }
  currentCard.es=newEs; currentCard.de=newDe;
  saveData(); editPanel.style.display="none"; toast(t("toast.saved")); render();
  setTimeout(()=>resetZoomIfNeeded(true), 30);
});

/* Drawer */
document.getElementById("drawerToggle").onclick=()=>{ drawer.classList.toggle("open"); };
drawerClose.onclick=()=> drawer.classList.remove("open");

/* Richtung */
toggleDirectionBtn.onclick=()=>{ direction=(direction==="es2de")?"de2es":"es2de"; saveData(); render(); };

/* Freies √úben */
freePracticeChk.addEventListener("change", ()=>{ freePractice=freePracticeChk.checked; saveData(); toast(freePractice?"Freies √úben: an":"Freies √úben: aus"); render(); });

/* Sprache */
langSelect.value = lang;
langSelect.addEventListener("change", ()=>{ lang = langSelect.value; saveData(); applyI18n(); render(); });

/* CSV Import ‚Äì robust */
csvFileInput.addEventListener("change",(ev)=>{
  const file=ev.target.files[0]; if(!file) return;
  const rdr=new FileReader();
  rdr.onload=e=>{
    const buf=e.target.result;
    const decs=[new TextDecoder("utf-8"), new TextDecoder("windows-1252"), new TextDecoder("iso-8859-1")];
    let text="", used="utf-8";
    for(const d of decs){ const t=d.decode(buf); const bad=(t.match(/\uFFFD/g)||[]).length; if(bad===0){ text=t; used=d.encoding||used; break; } if(!text) text=t; }
    if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
    const lines=text.split(/\r?\n/);
    let imported=0;
    const norm = s => (s||"").normalize('NFC').replace(/\s+/g,' ').trim();
    for(let raw of lines){
      raw = raw.trim();
      if(!raw) continue;
      if(raw.length>2000) continue;
      const sep=(raw.includes(";")&&(!raw.includes(",")||raw.indexOf(";")<raw.indexOf(",")))?";":",";
      const parts=raw.split(sep); if(parts.length<2) continue;
      let es=norm(parts[0]?.replace(/^"(.*)"$/,'$1'));
      let de=norm(parts[1]?.replace(/^"(.*)"$/,'$1'));
      if(!es||!de) continue;
      const exists=activeCards.some(c=>norm(c.es)===es)
                 || reserveCards.some(c=>norm(c.es)===es)
                 || learnedCards.some(c=>norm(c.es)===es);
      if(!exists){ reserveCards.push({id:cryptoId(), es,de,box:1,lastSeen:null,wrong:0,introduced:false}); imported++; }
    }
    saveData(); alert(`Import: ${imported} (${used})`); render();
  };
  rdr.readAsArrayBuffer(file);
});

/* Add Card */
addCardBtn.onclick=()=>{
  const es=(document.getElementById("spanish").value||"").trim();
  const de=(document.getElementById("german").value||"").trim();
  if(!es||!de) return;
  const norm=s=>s.normalize('NFC').replace(/\s+/g,' ').trim();
  const esN=norm(es);
  const exists=activeCards.some(c=>norm(c.es)===esN)||reserveCards.some(c=>norm(c.es)===esN)||learnedCards.some(c=>norm(c.es)===esN);
  if(exists){ alert("Schon vorhanden."); return; }
  reserveCards.push({id:cryptoId(), es:esN, de:norm(de), box:1,lastSeen:null,wrong:0,introduced:false});
  document.getElementById("spanish").value=""; document.getElementById("german").value="";
  saveData(); toast(t("toast.added")); render();
};

/* L√∂schen */
deleteBtn.onclick=()=>{
  if(!currentCard) return;
  if(!confirm("Karte l√∂schen?")) return;
  const i=activeCards.indexOf(currentCard);
  if(i>=0) activeCards.splice(i,1); else{
    const ir=reserveCards.indexOf(currentCard); if(ir>=0) reserveCards.splice(ir,1);
  }
  saveData(); toast(t("toast.deleted")); render();
};

/* Reset */
resetProgressBtn.onclick=()=>{ if(!confirm("Nur Lernfortschritt zur√ºcksetzen?")) return;
  activeCards=activeCards.map(c=>({...c, box:1, lastSeen:null, introduced:false}));
  saveData(); toast(t("toast.reset")); render();
};
resetAllBtn.onclick=()=>{ if(!confirm("Alle Daten dieser √úbung l√∂schen?")) return;
  ["leitnerActive","leitnerReserve","leitnerLearned","leitnerDirection","points","level","streak","achievements","lastActivityDate","dayCounts","freePractice","haptics","currentTestBox"].forEach(k=>localStorage.removeItem(`${k}_${currentDeckId}`));
  activeCards=[]; reserveCards=[]; learnedCards=[]; direction="es2de"; points=0; level=1; streak=0; achievements=[]; lastActivityDate=null; dayCounts={}; freePractice=false; haptics=true; currentTestBox=1;
  saveData(); toast(t("toast.init")); render();
};

/* Decks */
function rebuildDeckSelect(){
  deckSelect.innerHTML="";
  decks.forEach(d=>{ const o=document.createElement("option"); o.value=d.id; o.textContent=d.name+(d.id===currentDeckId?" (aktiv)":""); deckSelect.appendChild(o); });
  deckSelect.value=currentDeckId;
}
rebuildDeckSelect();
deckSelect.onchange=()=>{ currentDeckId=deckSelect.value; saveDecks();
  activeCards=JSON.parse(localStorage.getItem(deckKey("leitnerActive")))||[];
  reserveCards=JSON.parse(localStorage.getItem(deckKey("leitnerReserve")))||[];
  learnedCards=JSON.parse(localStorage.getItem(deckKey("leitnerLearned")))||[];
  direction=localStorage.getItem(deckKey("leitnerDirection"))||"es2de";
  points=parseInt(localStorage.getItem(deckKey("points"))||"0",10);
  level=parseInt(localStorage.getItem(deckKey("level"))||"1",10);
  streak=parseInt(localStorage.getItem(deckKey("streak"))||"0",10);
  achievements=JSON.parse(localStorage.getItem(deckKey("achievements"))||"[]");
  lastActivityDate=localStorage.getItem(deckKey("lastActivityDate"))||null;
  dayCounts=JSON.parse(localStorage.getItem(deckKey("dayCounts"))||"{}");
  freePractice=JSON.parse(localStorage.getItem(deckKey("freePractice"))||"false");
  haptics=JSON.parse(localStorage.getItem(deckKey("haptics"))||"true");
  currentTestBox=parseInt(localStorage.getItem(deckKey("currentTestBox"))||"1",10);
  render();
};
deckAddBtn.onclick=()=>{ const name=prompt("Name der neuen √úbung:"); if(!name) return;
  const id=uuid(); decks.push({id,name}); saveDecks();
  currentDeckId=id; rebuildDeckSelect();
  activeCards=[]; reserveCards=[]; learnedCards=[];
  direction="es2de"; points=0; level=1; streak=0; achievements=[]; lastActivityDate=null; dayCounts={}; freePractice=false; haptics=true; currentTestBox=1;
  saveData(); render();
};
deckRenameBtn.onclick=()=>{ const deck=decks.find(d=>d.id===currentDeckId); if(!deck) return;
  const name=prompt("Neuer Name:", deck.name); if(!name) return; deck.name=name; saveDecks(); rebuildDeckSelect();
};
deckDeleteBtn.onclick=()=>{ if(decks.length<=1){ alert("Mindestens eine √úbung muss bleiben."); return; }
  const deck=decks.find(d=>d.id===currentDeckId);
  if(!deck || !confirm(`‚Äû${deck.name}‚Äú wirklich l√∂schen?`)) return;
  ["leitnerActive","leitnerReserve","leitnerLearned","leitnerDirection","points","level","streak","achievements","lastActivityDate","dayCounts","freePractice","haptics","currentTestBox"].forEach(k=>localStorage.removeItem(`${k}_${currentDeckId}`));
  decks=decks.filter(d=>d.id!==currentDeckId); currentDeckId=decks[0].id; saveDecks(); rebuildDeckSelect(); deckSelect.onchange();
};

/* Suche/Liste */
function esc(s){ return (s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
function buildTable(){
  const q=searchInput.value.trim().toLowerCase(); const incl=showReserveChk.checked;
  let rows=activeCards.map(c=>({...c,_w:"aktiv"})); if(incl) rows=rows.concat(reserveCards.map(c=>({...c,_w:"reserve"})));
  if(q) rows=rows.filter(r=>(r.es||"").toLowerCase().includes(q)||(r.de||"").toLowerCase().includes(q));
  const sort=listSortSelect.value;
  rows.sort((a,b)=>{
    if(sort==="wrongdesc") return (b.wrong||0)-(a.wrong||0);
    if(sort==="alphaes") return (a.es||"").localeCompare(b.es||"");
    if(sort==="alphade") return (a.de||"").localeCompare(b.de||"");
    if(b.box!==a.box) return (b.box||0)-(a.box||0);
    return (b.wrong||0)-(a.wrong||0);
  });
  const tb=cardsTable; tb.innerHTML="";
  for(const r of rows){
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${esc(r.es)}</td><td>${esc(r.de)}</td><td>${r.box||"-"}${r._w==="reserve"?"*":""}</td><td>${r.wrong||0}</td><td>${r.lastSeen?new Date(r.lastSeen).toLocaleDateString('de-DE'):"-"}</td><td><button class="ghost" data-e>Edit</button><button class="danger" data-d>Del</button></td>`;
    tr.querySelector("[data-e]").onclick=()=>{ const es=prompt("Spanisch:",r.es); if(es===null)return; const de=prompt("Deutsch:",r.de); if(de===null)return; if(!es.trim()||!de.trim())return;
      const coll=(arr,es0,same)=>arr.some(c=>c!==same&&c.es===es0);
      if(coll(activeCards,es,r)||coll(reserveCards,es,r)||coll(learnedCards,es,r)){ alert("Karte mit dieser spanischen Seite existiert bereits."); return; }
      r.es=es.trim(); r.de=de.trim(); saveData(); toast(t("toast.saved")); render(); };
    tr.querySelector("[data-d]").onclick=()=>{ if(!confirm("Karte l√∂schen?"))return; let arr=(r._w==="reserve")?reserveCards:activeCards; const i=arr.indexOf(r); if(i>=0)arr.splice(i,1); saveData(); toast(t("toast.deleted")); render(); };
    tb.appendChild(tr);
  }
}
searchInput.oninput=buildTable; listSortSelect.onchange=buildTable; showReserveChk.onchange=buildTable;

/* ===== Box-Diagramm & Auswahl ===== */
function buildBoxChart(){
  const counts=[1,2,3,4,5].map(b=>activeCards.filter(c=>c.box===b).length);
  const max=Math.max(1,...counts);
  boxChart.innerHTML="";
  [1,2,3,4,5].forEach((b,i)=>{
    const bar=document.createElement("div");
    bar.className="bar"+(b===currentTestBox?" active":"");
    bar.style.height = (Math.max(6, Math.round(counts[i]/max*100)))+"%";
    bar.innerHTML = `<span>B${b}</span><label>${counts[i]}</label>`;
    bar.title=`Box ${b}: ${counts[i]}`;
    bar.onclick=()=>{ currentTestBox=b; saveData(); render(); };
    boxChart.appendChild(bar);
  });
}

/* ===== Frische Karten (Box 1) ===== */
freshBtn.addEventListener("click", ()=>{
  const take = Math.min(batchSizeFresh, reserveCards.length);
  const add = reserveCards.splice(0, take);
  add.forEach(c=>{ c.box=1; c.lastSeen=null; c.wrong=c.wrong||0; c.introduced=false; c.id=c.id||cryptoId(); });
  activeCards.push(...add); saveData(); toast(`üÜï ${take} ${t("btn.fresh")}`); updateLandInfo(); updateStats();
});

/* ===== Gesten & Mode-Toggle ===== */
toggleModeBtn.onclick=()=>{ mode=(mode==="lernen")?"pr√ºfen":"lernen"; editPanel.style.display="none"; combo=0; comboChip.style.display="none"; lastShownIds=[]; saveData(); render(); };

/* ===== Start ===== */
applyI18n();
render();

/* PWA: Service Worker laden (Version-Bump via ?v=7) */
if('serviceWorker' in navigator){ addEventListener('load', ()=>navigator.serviceWorker.register('./service-worker.js?v=7').catch(console.error)); }
</script>
</body>
</html>
